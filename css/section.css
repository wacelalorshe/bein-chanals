// Firebase configuration - Ù†ÙØ³ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
const firebaseConfig = {
    apiKey: "AIzaSyAkgEiYYlmpMe0NLewulheovlTQMz5C980",
    authDomain: "bein-42f9e.firebaseapp.com",
    projectId: "bein-42f9e",
    storageBucket: "bein-42f9e.firebasestorage.app",
    messagingSenderId: "143741167050",
    appId: "1:143741167050:web:922d3a0cddb40f67b21b33",
    measurementId: "G-JH198SKCFS"
};

// Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù„Ù…ÙŠØ©
let db = null;
let isFirebaseInitialized = false;

// Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª
async function checkInternetConnection() {
    return new Promise((resolve, reject) => {
        if (!navigator.onLine) {
            reject(new Error("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª"));
            return;
        }

        const img = new Image();
        img.src = "https://www.google.com/images/phd/px.gif?t=" + new Date().getTime();
        let timer = setTimeout(() => {
            reject(new Error("Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª"));
        }, 5000);

        img.onload = () => {
            clearTimeout(timer);
            resolve(true);
        };

        img.onerror = () => {
            clearTimeout(timer);
            reject(new Error("ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª"));
        };
    });
}

// Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù‚Ø¨Ù„ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ ØµÙØ­Ø©
async function navigateWithConnectionCheck(url) {
    const overlay = document.createElement('div');
    overlay.style.position = 'fixed';
    overlay.style.top = '0';
    overlay.style.left = '0';
    overlay.style.width = '100%';
    overlay.style.height = '100%';
    overlay.style.backgroundColor = 'rgba(0,0,0,0.8)';
    overlay.style.zIndex = '9999';
    overlay.style.display = 'flex';
    overlay.style.flexDirection = 'column';
    overlay.style.justifyContent = 'center';
    overlay.style.alignItems = 'center';
    overlay.style.color = 'white';
    overlay.style.fontSize = '18px';
    overlay.style.textAlign = 'center';
    overlay.style.backdropFilter = 'blur(5px)';
    overlay.innerHTML = `
        <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
            <span class="visually-hidden">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...</span>
        </div>
        <p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª...</p>
    `;
    
    document.body.appendChild(overlay);
    
    try {
        await checkInternetConnection();
        overlay.remove();
        window.location.href = url;
    } catch (error) {
        overlay.innerHTML = `
            <i class="uil uil-wifi-slash mb-3" style="font-size: 3rem; color: #ff6b6b;"></i>
            <h4>âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª</h4>
            <p>${error.message || "ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª"}</p>
            <div class="mt-4">
                <button onclick="window.location.reload()" class="btn btn-primary me-2">
                    <i class="uil uil-redo"></i> Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
                </button>
                <button onclick="this.parentElement.parentElement.remove()" class="btn btn-secondary">
                    <i class="uil uil-times"></i> Ø¥ØºÙ„Ø§Ù‚
                </button>
            </div>
        `;
    }
}

// Ø¯Ø§Ù„Ø© Ù„Ù„Ø°Ù‡Ø§Ø¨ Ø¥Ù„Ù‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚
function goToIndexWithCheck() {
    navigateWithConnectionCheck('index.html');
}

// Ø¯Ø§Ù„Ø© Ù„Ù„Ø°Ù‡Ø§Ø¨ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚
function goToMatchesWithCheck() {
    navigateWithConnectionCheck('matches.html');
}

// Ø¯Ø§Ù„Ø© Ù„ØªÙ‡ÙŠØ¦Ø© Firebase
async function initializeFirebase() {
    return new Promise((resolve, reject) => {
        try {
            console.log('ğŸš€ Ù…Ø­Ø§ÙˆÙ„Ø© ØªÙ‡ÙŠØ¦Ø© Firebase...');
            
            if (typeof firebase === 'undefined') {
                throw new Error('Firebase SDK Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡');
            }

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Firebase Ù…Ù‡ÙŠØ£ Ø¨Ø§Ù„ÙØ¹Ù„
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            
            // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ÙƒØ§Ø¦Ù† Firestore
            db = firebase.firestore();
            isFirebaseInitialized = true;
            
            console.log('âœ… Firebase Ù…Ù‡ÙŠØ£ Ø¨Ù†Ø¬Ø§Ø­');
            resolve(db);
            
        } catch (error) {
            console.error('âŒ ÙØ´Ù„ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Firebase:', error);
            reject(error);
        }
    });
}

// ØªØ·Ø¨ÙŠÙ‚ Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø³Ù…
class SectionApp {
    constructor() {
        this.section = null;
        this.channels = [];
        this.sectionId = null;
        this.init();
    }

    async init() {
        console.log('ğŸš€ Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ ØµÙØ­Ø© Ø§Ù„Ù‚Ø³Ù…...');
        
        // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        document.getElementById('currentYear').textContent = new Date().getFullYear();
        
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù Ø§Ù„Ù‚Ø³Ù… Ù…Ù† Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙØ­Ø©
        const urlParams = new URLSearchParams(window.location.search);
        this.sectionId = urlParams.get('id');
        
        console.log('ğŸ“‹ Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ù‚Ø³Ù…:', this.sectionId);
        
        if (!this.sectionId) {
            this.showError('Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù‚Ø³Ù…. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ÙˆØ§Ø®ØªÙŠØ§Ø± Ù‚Ø³Ù….');
            return;
        }
        
        // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
        this.setupEventListeners();
        
        // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        await this.loadData();
    }

    async loadData() {
        const container = document.getElementById('channelsContainer');
        
        // Ø¥Ø¶Ø§ÙØ© Ù…Ø¤Ø´Ø± ØªØ­Ù…ÙŠÙ„ Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„
        container.innerHTML = `
            <div class="loading">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...</span>
                </div>
                <p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª...</p>
            </div>
        `;
        
        try {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø£ÙˆÙ„Ø§Ù‹
            await checkInternetConnection();
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø§ØªØµØ§Ù„ØŒ ØªØ§Ø¨Ø¹ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            try {
                // Ø£ÙˆÙ„Ø§Ù‹: Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† Firebase
                const firebaseLoaded = await this.tryLoadFromFirebase();
                
                if (firebaseLoaded) {
                    console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase');
                    return;
                }
                
                // Ø«Ø§Ù†ÙŠØ§Ù‹: Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ
                const localStorageLoaded = await this.tryLoadFromLocalStorage();
                
                if (localStorageLoaded) {
                    console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ');
                    return;
                }
                
                // Ø¥Ø°Ø§ ÙØ´Ù„ ÙƒÙ„ Ø´ÙŠØ¡
                this.showError('ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ØªØ£ÙƒØ¯ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.');
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹:', error);
                this.showError('Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹: ' + error.message);
            }
            
        } catch (connectionError) {
            console.error('Connection error:', connectionError);
            
            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø§Ù„Ù…Ø®Ø²Ù†Ø© ÙƒØ¨Ø¯ÙŠÙ„
            try {
                const localStorageLoaded = await this.tryLoadFromLocalStorage();
                
                if (localStorageLoaded) {
                    console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ Ø¨Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª');
                    
                    // Ø¥Ø¶Ø§ÙØ© ØªÙ†Ø¨ÙŠÙ‡ Ø¨Ø£Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¯ÙŠÙ…Ø©
                    const container = document.getElementById('channelsContainer');
                    const warning = document.createElement('div');
                    warning.className = 'connection-warning';
                    warning.innerHTML = `
                        <i class="uil uil-wifi-slash"></i>
                        <strong>ØªÙ†Ø¨ÙŠÙ‡:</strong> Ø£Ù†Øª Ø­Ø§Ù„ÙŠØ§Ù‹ Ø¨Ø¯ÙˆÙ† Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª. ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø²Ù†Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹.
                        <button onclick="window.location.reload()" class="btn-retry">
                            <i class="uil uil-redo"></i> ØªØ­Ø¯ÙŠØ«
                        </button>
                    `;
                    container.parentNode.insertBefore(warning, container);
                    
                    return;
                }
            } catch (localError) {
                console.error('Failed to load from localStorage:', localError);
            }
            
            // Ø¥Ø°Ø§ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
            this.showError(`
                <div class="text-center">
